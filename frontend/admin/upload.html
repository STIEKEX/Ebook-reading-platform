<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Book | Admin Dashboard</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="./admin.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .upload-container {
            background: #fff;
            border-radius: 10px;
            padding: 2.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 2rem auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            border-color: #f39c12;
            outline: none;
            box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: #fafafa;
        }

        .file-upload-box:hover {
            border-color: #f39c12;
            background: #fff9f0;
        }

        .file-upload-box input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-box p {
            margin: 0.5rem 0 0 0;
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        .file-info {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #4CAF50;
            font-weight: 500;
        }

        .preview {
            margin-top: 1rem;
            text-align: center;
        }

        .preview img {
            max-width: 150px;
            max-height: 200px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.85rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #f39c12;
            color: white;
        }

        .btn-primary:hover {
            background: #e67e22;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress {
            width: 0%;
            height: 100%;
            background: #f39c12;
            transition: width 0.3s;
        }

        #message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 5px;
        }

        #message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        #message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: #666;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #f39c12;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .upload-container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <i class='bx bx-book-reader'></i>
            <span>E-Book Admin</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html">
                <i class='bx bxs-dashboard'></i>
                <span>Dashboard</span>
            </a>
            <a href="books.html">
                <i class='bx bx-library'></i>
                <span>Book Management</span>
            </a>
            <a href="upload.html" class="active">
                <i class='bx bx-upload'></i>
                <span>Upload Books</span>
            </a>
            <a href="users.html">
                <i class='bx bx-user'></i>
                <span>User Management</span>
            </a>
            <a href="reviews.html">
                <i class='bx bx-star'></i>
                <span>Reviews</span>
            </a>
            <a href="analytics.html">
                <i class='bx bx-line-chart'></i>
                <span>Analytics</span>
            </a>
            <a href="categories.html">
                <i class='bx bx-category'></i>
                <span>Categories</span>
            </a>
            <a href="settings.html">
                <i class='bx bx-cog'></i>
                <span>Settings</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn" onclick="logout()">
                <i class='bx bx-log-out'></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div>
                <h1>Upload New Book</h1>
                <p class="muted">Add a new book to your digital library</p>
            </div>
        </header>

        <div class="upload-container">
            <form id="uploadForm" onsubmit="handleUpload(event)">
                <!-- Row 1: Title and Author -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="author">Author *</label>
                        <input type="text" id="author" name="author" required>
                    </div>
                </div>

                <!-- Row 2: ISBN and Category -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="isbn">ISBN</label>
                        <input type="text" id="isbn" name="isbn">
                    </div>

                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="fiction">Fiction</option>
                            <option value="non-fiction">Non-Fiction</option>
                            <option value="science">Science</option>
                            <option value="technology">Technology</option>
                            <option value="business">Business</option>
                            <option value="arts">Arts</option>
                            <option value="history">History</option>
                            <option value="biography">Biography</option>
                            <option value="education">Education</option>
                            <option value="romance">Romance</option>
                            <option value="mystery">Mystery</option>
                            <option value="thriller">Thriller</option>
                            <option value="sci-fi">Sci-Fi</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" rows="4" required></textarea>
                </div>

                <!-- Row 3: Tags and Language -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="tags">Tags (comma-separated)</label>
                        <input type="text" id="tags" name="tags" placeholder="fiction, fantasy, adventure">
                    </div>

                    <div class="form-group">
                        <label for="language">Language</label>
                        <select id="language" name="language">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Row 4: Book File and Cover Image -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Book File (PDF/EPUB) *</label>
                        <div class="file-upload-box" id="bookFileUpload">
                            <i class='bx bx-upload' style='color:#f39c12; font-size: 2.5rem;'></i>
                            <p>Drag and drop your book file<br>here or click to browse</p>
                            <input type="file" id="bookFile" name="bookFile" accept=".pdf,.epub" required>
                            <div class="file-info" id="bookFileInfo"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Cover Image *</label>
                        <div class="file-upload-box" id="coverImageUpload">
                            <i class='bx bx-image' style='color:#f39c12; font-size: 2.5rem;'></i>
                            <p>Drag and drop cover image or<br>click to browse</p>
                            <input type="file" id="coverImage" name="coverImage" accept="image/*" required>
                            <div class="file-info" id="coverImageInfo"></div>
                        </div>
                        <div class="preview" id="imagePreview"></div>
                    </div>
                </div>

                <!-- Feature Checkbox -->
                <div class="form-group" style="margin-top: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="featured" name="featured">
                        <span>Feature this book on homepage</span>
                    </label>
                </div>

                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress" id="progress"></div>
                </div>

                <div class="loading" id="loading" style="display: none;">
                    <i class='bx bx-loader bx-spin'></i>
                    <span>Uploading book...</span>
                </div>

                <div id="message"></div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #f39c12; border: none;">
                        <i class='bx bx-upload'></i> Upload Book
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/adminAuth.js"></script>
    <script>
        // File upload previews
        function handleFileSelect(fileInput, infoElement, previewElement = null) {
            const file = fileInput.files[0];
            if (!file) return;

            const fileInfo = document.getElementById(infoElement);
            fileInfo.textContent = `${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;

            if (previewElement && file.type.startsWith('image/')) {
                const preview = document.getElementById(previewElement);
                const reader = new FileReader();

                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Cover preview">`;
                };

                reader.readAsDataURL(file);
            }
        }

        // Set up file input handlers
        document.getElementById('bookFile').addEventListener('change', function() {
            handleFileSelect(this, 'bookFileInfo');
        });

        document.getElementById('coverImage').addEventListener('change', function() {
            handleFileSelect(this, 'coverImageInfo', 'imagePreview');
        });

        // Form submission handler
        async function handleUpload(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData();
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            const submitBtn = form.querySelector('button[type="submit"]');

            try {
                // Show loading state
                progressBar.style.display = 'block';
                loading.style.display = 'flex';
                message.style.display = 'none';
                message.className = '';
                submitBtn.disabled = true;

                // Build FormData: send cover first, then book file
                const coverFile = document.getElementById('coverImage').files[0];
                const bookFile = document.getElementById('bookFile').files[0];
                
                if (!coverFile) {
                    throw new Error('Cover image is required');
                }
                if (!bookFile) {
                    throw new Error('Book file is required');
                }

                console.log('üì§ Uploading book:', {
                    title: form.title.value,
                    author: form.author.value,
                    category: form.category.value,
                    coverSize: (coverFile.size / 1024 / 1024).toFixed(2) + ' MB',
                    bookSize: (bookFile.size / 1024 / 1024).toFixed(2) + ' MB'
                });

                // Append files (cover first, then PDF)
                formData.append('files', coverFile);
                formData.append('files', bookFile);

                // Append text fields
                formData.append('title', form.title.value);
                formData.append('author', form.author.value);
                formData.append('description', form.description.value);
                formData.append('category', form.category.value);
                
                // Optional fields
                if (form.isbn && form.isbn.value) {
                    formData.append('isbn', form.isbn.value);
                }
                if (form.tags && form.tags.value) {
                    formData.append('tags', form.tags.value);
                }
                if (form.language && form.language.value) {
                    formData.append('language', form.language.value);
                }
                if (form.featured && form.featured.checked) {
                    formData.append('featured', 'true');
                }

                // Upload the book
                console.log('üöÄ Sending request to:', `${API_BASE}/books/upload`);
                
                const response = await fetch(`${API_BASE}/books/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                console.log('üì° Response status:', response.status, response.statusText);
                console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));

                let result;
                try {
                    const text = await response.text();
                    console.log('üì° Raw response:', text);
                    result = text ? JSON.parse(text) : {};
                } catch (e) {
                    console.error('Failed to parse response:', e);
                    throw new Error('Invalid response from server');
                }
                
                console.log('üì• Upload response:', result);

                if (!response.ok) {
                    throw new Error(result.message || `Upload failed (${response.status})`);
                }

                if (result.book || result.message === 'Book uploaded successfully') {
                    message.className = 'success';
                    message.innerHTML = '‚úÖ Book uploaded successfully! Redirecting...';
                    message.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = 'books.html';
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                
                // Check if it's a network error
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    message.className = 'error';
                    message.innerHTML = `‚ùå Cannot connect to server. Please ensure:<br>
                        1. Backend server is running on http://localhost:5000<br>
                        2. Check browser console for details<br>
                        Error: ${error.message}`;
                    message.style.display = 'block';
                } else {
                    message.className = 'error';
                    message.innerHTML = `‚ùå ${error.message}`;
                    message.style.display = 'block';
                }
                submitBtn.disabled = false;
            } finally {
                loading.style.display = 'none';
                progressBar.style.display = 'none';
            }
        }

        // Drag and drop handling
        ['bookFileUpload', 'coverImageUpload'].forEach(id => {
            const dropZone = document.getElementById(id);
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#4CAF50';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ddd';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ddd';
                
                const input = dropZone.querySelector('input[type="file"]');
                const dt = e.dataTransfer;
                const files = dt.files;

                input.files = files;
                const event = new Event('change');
                input.dispatchEvent(event);
            });
        });

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìö Upload page loaded');
            console.log('API_BASE:', API_BASE);
            console.log('Token:', localStorage.getItem('token') ? 'Present' : 'Missing');
            
            if (!isLoggedIn()) {
                console.warn('‚ö†Ô∏è User not logged in, redirecting...');
                window.location.href = '../pages/login.html';
                return;
            }

            const user = getCurrentUser();
            console.log('üë§ Current user:', user);
            
            if (!user || !user.isAdmin) {
                console.warn('‚ö†Ô∏è User is not admin, redirecting...');
                window.location.href = '../main.html';
                return;
            }
            
            console.log('‚úÖ Admin authenticated, ready to upload');
        });
    </script>
</body>
</html>